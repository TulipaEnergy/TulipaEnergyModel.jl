<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Two-Stage Stochastic Optimization ¬∑ TulipaEnergyModel.jl</title><meta name="title" content="Two-Stage Stochastic Optimization ¬∑ TulipaEnergyModel.jl"/><meta property="og:title" content="Two-Stage Stochastic Optimization ¬∑ TulipaEnergyModel.jl"/><meta property="twitter:title" content="Two-Stage Stochastic Optimization ¬∑ TulipaEnergyModel.jl"/><meta name="description" content="Documentation for TulipaEnergyModel.jl."/><meta property="og:description" content="Documentation for TulipaEnergyModel.jl."/><meta property="twitter:description" content="Documentation for TulipaEnergyModel.jl."/><meta property="og:url" content="https://TulipaEnergy.github.io/TulipaEnergyModel.jl/10-tutorials/18-stochastic/"/><meta property="twitter:url" content="https://TulipaEnergy.github.io/TulipaEnergyModel.jl/10-tutorials/18-stochastic/"/><link rel="canonical" href="https://TulipaEnergy.github.io/TulipaEnergyModel.jl/10-tutorials/18-stochastic/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="TulipaEnergyModel.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">TulipaEnergyModel.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Welcome</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../11-setting-up/">Tutorial Setup</a></li><li><a class="tocitem" href="../12-basics/">The Basics</a></li><li><a class="tocitem" href="../13-assets/">Gereralized Assets and Flows</a></li><li><a class="tocitem" href="../14-fully-flexible-time/">Fully-Flexible Time Resolution</a></li><li><a class="tocitem" href="../15-clustering-rep-periods/">Blended Representative Periods with Tulipa Clustering</a></li><li><a class="tocitem" href="../16-storage/">Seasonal and Non-seasonal Storage</a></li><li><a class="tocitem" href="../17-multi-year-investments/">Multi-Year Investment Pathways</a></li><li class="is-active"><a class="tocitem" href>Two-Stage Stochastic Optimization</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Two-Stage-Stochastic-Optimization-with-TulipaEnergyModel.jl"><span>Two-Stage Stochastic Optimization with TulipaEnergyModel.jl</span></a></li><li><a class="tocitem" href="#Loading-the-basic-input-data"><span>Loading the basic input data</span></a></li><li><a class="tocitem" href="#Profiles-Depending-on-the-Scenario"><span>Profiles Depending on the Scenario</span></a></li><li><a class="tocitem" href="#Clustering-Per-Scenario"><span>Clustering Per Scenario</span></a></li><li><a class="tocitem" href="#Clustering-Cross-Scenario"><span>Clustering Cross Scenario</span></a></li><li><a class="tocitem" href="#Implications-in-Tulipa-Energy-Model-Formulation"><span>Implications in Tulipa Energy Model Formulation</span></a></li><li><a class="tocitem" href="#Solving-the-Stochastic-Optimization-Problem"><span>Solving the Stochastic Optimization Problem</span></a></li></ul></li><li><a class="tocitem" href="../30-workflow/">Data-Handling Workflow (Example)</a></li><li><a class="tocitem" href="../31-rolling-horizon/">Rolling Horizon</a></li><li><a class="tocitem" href="../40-bids-workaround/">Bids using Consumer Unit Commitment (Workaround)</a></li><li><a class="tocitem" href="../99-manual-steps/">Advanced Control</a></li></ul></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../20-user-guide/00-getting-started/">Getting Started</a></li><li><a class="tocitem" href="../../20-user-guide/20-how-to-use/">How to Use</a></li><li><a class="tocitem" href="../../20-user-guide/50-workflow/">Analysis Workflow</a></li><li><a class="tocitem" href="../../20-user-guide/54-input-table-schemas/">Input Table Schemas</a></li><li><a class="tocitem" href="../../20-user-guide/55-outputs/">Output Variables</a></li><li><a class="tocitem" href="../../20-user-guide/60-structures/">Internal Model Structures</a></li><li><a class="tocitem" href="../../20-user-guide/65-FFTR-table/">FFTR Constraints Table</a></li></ul></li><li><a class="tocitem" href="../../30-concepts/">Concepts</a></li><li><span class="tocitem">Scientific Foundation</span><ul><li><a class="tocitem" href="../../40-scientific-foundation/40-formulation/">Mathematical Formulation</a></li><li><a class="tocitem" href="../../40-scientific-foundation/45-scientific-references/">Scientific References</a></li></ul></li><li><a class="tocitem" href="../../70-reference/">API Reference</a></li><li><a class="tocitem" href="../../80-ecosystem/">Tulipa Ecosystem</a></li><li><span class="tocitem">Contributing</span><ul><li><a class="tocitem" href="../../90-contributing/90-contributing/">Contributing Guidelines</a></li><li><a class="tocitem" href="../../90-contributing/91-developer/">Developer Documentation</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Two-Stage Stochastic Optimization</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Two-Stage Stochastic Optimization</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TulipaEnergy/TulipaEnergyModel.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/TulipaEnergy/TulipaEnergyModel.jl/blob/main/docs/src/10-tutorials/18-stochastic.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Two-Stage-Stochastic-Optimization"><a class="docs-heading-anchor" href="#Two-Stage-Stochastic-Optimization">Two-Stage Stochastic Optimization</a><a id="Two-Stage-Stochastic-Optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Two-Stage-Stochastic-Optimization" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>Stochastic programming is often used to represent the uncertainty in medium- and long-term optimization problems in energy systems, based on the basis that the <em>uncertainty can be represented by a known probability distribution</em>. In the context of energy systems, this <strong>uncertainty can be related to the availability of renewable energy sources, demand fluctuations, or hydro inflows</strong>. Stochastic programming allows for the incorporation of uncertainty by sampling the uncertainty space and creating multiple scenarios that represent different possible future outcomes. This approach enables decision-makers to make informed choices that are prepared against a range of possible future conditions.</p><p>A <strong>two-stage stochastic</strong> setting is when there are first stage decisions that are unique for each scenario and there are second stage decisions that are made after the uncertainty is realized. In the context of energy systems, the first stage decisions could be related to investment decisions, such as the capacity of new renewable energy sources to be built, while the second stage decisions could be related to operational decisions, such as how to dispatch the available generation resources to meet demand.</p><p><img src="../../figs/two-stage-stochastic-programming.png" alt="two stage stochastic programming"/></p><h2 id="Two-Stage-Stochastic-Optimization-with-TulipaEnergyModel.jl"><a class="docs-heading-anchor" href="#Two-Stage-Stochastic-Optimization-with-TulipaEnergyModel.jl">Two-Stage Stochastic Optimization with TulipaEnergyModel.jl</a><a id="Two-Stage-Stochastic-Optimization-with-TulipaEnergyModel.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Two-Stage-Stochastic-Optimization-with-TulipaEnergyModel.jl" title="Permalink"></a></h2><p>TulipaEnergyModel.jl approach to two-stage stochastic optimization is based on the concept of Representative Periods (RPs). RPs are a way to reduce the size of the problem by clustering similar time periods together, see tutorial <a href="../15-clustering-rep-periods/#blended-representative-periods">Blended Representative Periods with Tulipa Clustering</a>. This is particularly useful in the context of energy systems, where there can be a large number of time periods to consider. By clustering similar time periods together, we can reduce the number of variables and constraints in the optimization problem, making it more tractable.</p><p>In the stochastic setting, RPs can be clustered Per or Cross the stochastic scenarios. In that case, the representative periods mapping matrix will relate original periods to representative periods either per scenario (diagonal block structure) or across scenarios (full matrix structure). Here is the concept documentation for more detail: <a href="https://tulipaenergy.github.io/TulipaClustering.jl/stable/20-concepts/#Clustering-Per-or-Cross">Clustering per or Cross</a></p><p>Let&#39;s see how to implement two-stage stochastic optimization with TulipaEnergyModel.jl and TulipaClustering.jl.</p><h2 id="Loading-the-basic-input-data"><a class="docs-heading-anchor" href="#Loading-the-basic-input-data">Loading the basic input data</a><a id="Loading-the-basic-input-data-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-the-basic-input-data" title="Permalink"></a></h2><p>We import the necessary packages, and load the data in the DuckDB.</p><div class="admonition is-success" id="Remember!-3c3cba2cc5d12646"><header class="admonition-header">Remember!<a class="admonition-anchor" href="#Remember!-3c3cba2cc5d12646" title="Permalink"></a></header><div class="admonition-body"><ol><li>Activate your local enviroment and instantiate the project, if you haven&#39;t already.</li><li>Adjust the path to where you have the data stored.</li></ol></div></div><pre><code class="language-julia hljs">import TulipaIO as TIO
import TulipaEnergyModel as TEM
import TulipaClustering as TC
import CSV
import Distances
using DuckDB
using DataFrames
using Plots
using Statistics

connection = DBInterface.connect(DuckDB.DB)
input_dir = &quot;my-awesome-energy-system/tutorial-9&quot;
TIO.read_csv_folder(connection, input_dir)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">DuckDB.DB(&quot;:memory:&quot;)</code></pre><p>Here is a schematic of the energy system we are modeling:</p><pre><code class="language-mermaid hljs">flowchart TD
ens            --&gt; e_demand
ocgt           --&gt; e_demand
ccgt           --&gt; e_demand
wind           --&gt; e_demand
solar          --&gt; e_demand
electrolizer   --&gt; h2_demand
e_demand       --&gt; electrolizer
smr_ccs        --&gt; h2_demand
wind_offshore  --&gt; e_demand
wind_offshore  --&gt; electrolizer
battery        --&gt; e_demand
e_demand       --&gt; battery
h2_storage     --&gt; h2_demand
h2_demand      --&gt; h2_storage
hydro_reservoir--&gt; e_demand
hydro_reservoir--&gt; spillage</code></pre><h2 id="Profiles-Depending-on-the-Scenario"><a class="docs-heading-anchor" href="#Profiles-Depending-on-the-Scenario">Profiles Depending on the Scenario</a><a id="Profiles-Depending-on-the-Scenario-1"></a><a class="docs-heading-anchor-permalink" href="#Profiles-Depending-on-the-Scenario" title="Permalink"></a></h2><p>So far the profiles have been for a single scenario. Now, we have profiles for multiple scenarios, which represent different weather years. Each scenario has 8760 time steps (1 year of hourly data) and profiles for solar, wind offshore, wind onshore, demand, and hydro inflow. Let&#39;s have a look at the profiles in the table <code>profiles_wide</code> and a summary of the information in it by grouping by year and scenario.</p><pre><code class="language-julia hljs">profiles = TIO.get_table(connection, &quot;profiles_wide&quot;)
gdf = groupby(profiles, [:year, :scenario])
selected_columns = [:solar, :wind_offshore, :wind_onshore, :demand, :hydro_inflow]
result_df = combine(gdf, selected_columns .=&gt; mean)</code></pre><div><div style = "float: left;"><span>3√ó7 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">year</th><th style = "text-align: left;">scenario</th><th style = "text-align: left;">solar_mean</th><th style = "text-align: left;">wind_offshore_mean</th><th style = "text-align: left;">wind_onshore_mean</th><th style = "text-align: left;">demand_mean</th><th style = "text-align: left;">hydro_inflow_mean</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">2030</td><td style = "text-align: right;">1995</td><td style = "text-align: right;">0.184707</td><td style = "text-align: right;">0.546041</td><td style = "text-align: right;">0.280675</td><td style = "text-align: right;">0.57874</td><td style = "text-align: right;">0.348237</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">2030</td><td style = "text-align: right;">2008</td><td style = "text-align: right;">0.180548</td><td style = "text-align: right;">0.48947</td><td style = "text-align: right;">0.26192</td><td style = "text-align: right;">0.577493</td><td style = "text-align: right;">0.294694</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">2030</td><td style = "text-align: right;">2009</td><td style = "text-align: right;">0.184904</td><td style = "text-align: right;">0.534144</td><td style = "text-align: right;">0.273043</td><td style = "text-align: right;">0.584813</td><td style = "text-align: right;">0.372662</td></tr></tbody></table></div><p>Here we can see that there are 3 different weather years (i.e., scenarios 1995, 2008, 2009) and you see the difference in the average capacities of the availability of the renewable sources and demand in different scenarios.</p><h2 id="Clustering-Per-Scenario"><a class="docs-heading-anchor" href="#Clustering-Per-Scenario">Clustering Per Scenario</a><a id="Clustering-Per-Scenario-1"></a><a class="docs-heading-anchor-permalink" href="#Clustering-Per-Scenario" title="Permalink"></a></h2><p>To obtain representative periods for each scenario, we first transform the data from wide to long format, notice that we exclude the scenario, year, and timestep columns since we want the profiles to be grouped by scenario as well.</p><pre><code class="language-julia hljs">TC.transform_wide_to_long!(
    connection,
    &quot;profiles_wide&quot;,
    &quot;profiles&quot;;
    exclude_columns=[&quot;scenario&quot;, &quot;year&quot;, &quot;timestep&quot;],
)</code></pre><p>To cluster per scenario and year, we define the profiles layout using TulipaClustering. The rest of the parameters are the same as in the previous tutorial on clustering. In this case, we want to cluster into 16 representative periods of 24 hours each.</p><pre><code class="language-julia hljs">layout = TC.ProfilesTableLayout(; cols_to_groupby = [:year, :scenario])
num_rps = 16
period_duration = 24
clusters = TC.cluster!(
    connection,
    period_duration,
    num_rps;
    method = :convex_hull,
    distance = Distances.CosineDist(),
    weight_type = :convex,
    layout = layout,
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{DataFrames.GroupKey{DataFrames.GroupedDataFrame{DataFrames.DataFrame}}, TulipaClustering.ClusteringResult} with 3 entries:
  GroupKey: (year = 2030, ‚Ä¶ =&gt; ClusteringResult(<span class="sgr1">1920√ó6 DataFrame</span>‚Ä¶
  GroupKey: (year = 2030, ‚Ä¶ =&gt; ClusteringResult(<span class="sgr1">1920√ó6 DataFrame</span>‚Ä¶
  GroupKey: (year = 2030, ‚Ä¶ =&gt; ClusteringResult(<span class="sgr1">1920√ó6 DataFrame</span>‚Ä¶</code></pre><h3 id="Heat-Map-Visualization-Per-Scenario"><a class="docs-heading-anchor" href="#Heat-Map-Visualization-Per-Scenario">Heat Map Visualization Per Scenario</a><a id="Heat-Map-Visualization-Per-Scenario-1"></a><a class="docs-heading-anchor-permalink" href="#Heat-Map-Visualization-Per-Scenario" title="Permalink"></a></h3><p>After the clustering, we can have a look at the <code>rep_periods_mapping</code> table and visualize it.</p><p>How do we want to visualize the mapping? A heat map is a tool that plots large matrices in a scaled manner.</p><pre><code class="language-julia hljs">rp_mapping = TIO.get_table(connection, &quot;rep_periods_mapping&quot;)
rp_mapping_wide = unstack(rp_mapping, :rep_period, :weight; fill = 0.0)
M = Matrix(rp_mapping_wide[:, Not([:scenario, :year, :period])])
heatmap(
    M;
    xlabel = &quot;Representative period per scenario&quot;,
    ylabel = &quot;Original periods x scenarios&quot;,
    xticks = (0:num_rps:size(M, 2)),
    yticks = (0:(8760/period_duration):size(M, 1)),
    colorbar_title = &quot;Weight&quot;,
    title = &quot;Representative period mapping&quot;,
    color = :GnBu,
)</code></pre><img src="303d65fe.svg" alt="Example block output"/><p>Observe that since we define 16 representative periods per year and per scenario, we have <code>16 rps * 1 year * 3 scenarios = 48</code> representative periods in total.</p><p>The y-axis represents an aggregation of scenarios, years, and original periods (365 days per scenario, since the representative periods duration is 24h). Each block of 8760/24=365 rows corresponds to the original periods that are mapped to each representative period for each scenario.</p><p>The mapping matrix has a diagonal block structure, which means that the representative periods are not shared across scenarios (i.e., each scenario has its own set of representative periods).</p><h2 id="Clustering-Cross-Scenario"><a class="docs-heading-anchor" href="#Clustering-Cross-Scenario">Clustering Cross Scenario</a><a id="Clustering-Cross-Scenario-1"></a><a class="docs-heading-anchor-permalink" href="#Clustering-Cross-Scenario" title="Permalink"></a></h2><p>TulipaClustering allows you to cluster across scenarios, which means that the representative periods can be shared across scenarios. This is useful when you want to capture common patterns across scenarios and reduce the number of representative periods even further. In that case, we need to define the layout differently, since we want to group by years and cross by scenarios. The rest of the parameters are the same as in the previous case.</p><pre><code class="language-julia hljs">layout = TC.ProfilesTableLayout(; cols_to_groupby = [:year], cols_to_crossby = [:scenario])
num_rps = 16
period_duration = 24
clusters = TC.cluster!(
    connection,
    period_duration,
    num_rps;
    method = :convex_hull,
    distance = Distances.CosineDist(),
    weight_type = :convex,
    layout = layout,
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{DataFrames.GroupKey{DataFrames.GroupedDataFrame{DataFrames.DataFrame}}, TulipaClustering.ClusteringResult} with 1 entry:
  GroupKey: (year = 2030,) =&gt; ClusteringResult(<span class="sgr1">1920√ó5 DataFrame</span>‚Ä¶</code></pre><h3 id="Heat-Map-visualization-Cross-Scenario"><a class="docs-heading-anchor" href="#Heat-Map-visualization-Cross-Scenario">Heat Map visualization Cross Scenario</a><a id="Heat-Map-visualization-Cross-Scenario-1"></a><a class="docs-heading-anchor-permalink" href="#Heat-Map-visualization-Cross-Scenario" title="Permalink"></a></h3><p>Let&#39;s visualize the mapping matrix again with a heat map.</p><pre><code class="language-julia hljs">rp_mapping = TIO.get_table(connection, &quot;rep_periods_mapping&quot;)
rp_mapping_wide = unstack(rp_mapping, :rep_period, :weight; fill = 0.0)
M = Matrix(rp_mapping_wide[:, Not([:scenario, :year, :period])])
heatmap(
    M;
    xlabel = &quot;Representative period across scenarios&quot;,
    ylabel = &quot;Original periods x scenarios&quot;,
    xticks = (0:num_rps:size(M, 2)),
    yticks = (0:(8760/period_duration):size(M, 1)),
    colorbar_title = &quot;Weight&quot;,
    title = &quot;Representative period mapping&quot;,
    color = :GnBu,
)</code></pre><img src="0354958d.svg" alt="Example block output"/><p>Observe that since we define 16 representative per year but across scenarios, we have <code>16 rps * 1 year = 16</code> representative periods in total.</p><p>The y-axis represents an aggregation of scenarios, years, and original periods (365 days per scenario, since the representative periods duration is 24h), just as before.</p><p>The mapping matrix has a full matrix structure, which means that the representative periods can be shared across scenarios (i.e., each scenario can have the same set of representative periods).</p><div class="admonition is-success" id="Making-the-comparison-fair-54f2b2f707fdba75"><header class="admonition-header">Making the comparison fair<a class="admonition-anchor" href="#Making-the-comparison-fair-54f2b2f707fdba75" title="Permalink"></a></header><div class="admonition-body"><p>To make the comparison between per and cross scenario clustering fair, we need to have the same number of representative periods in both cases. This way, we can compare the level of detail and performance of both approaches. In this example, we can increase the number of representative periods in the cross scenario case to 24, which is the same as in the per scenario case üòâ</p></div></div><h2 id="Implications-in-Tulipa-Energy-Model-Formulation"><a class="docs-heading-anchor" href="#Implications-in-Tulipa-Energy-Model-Formulation">Implications in Tulipa Energy Model Formulation</a><a id="Implications-in-Tulipa-Energy-Model-Formulation-1"></a><a class="docs-heading-anchor-permalink" href="#Implications-in-Tulipa-Energy-Model-Formulation" title="Permalink"></a></h2><p>This modelling approach has consequences in the formulation of the optimization problem, in particular in the formulation of the inter-temporal constraints. For instance, seasonal storage balance is scenario dependent to track seasonality within each scenario, while daily storage balance can be scenario independent if the representative periods are shared across scenarios. In general, the implications of clustering per or cross scenario are:</p><ol><li>Intra-period constraints are <strong>scenario independent</strong> and remain the same whether using cross-scenario or per-scenario approaches. Without inter-period constraints, cross vs per-scenario makes no difference</li><li>Inter-period constraints are <strong>always scenario dependent</strong>, regardless of cross or per-scenario approach</li></ol><h2 id="Solving-the-Stochastic-Optimization-Problem"><a class="docs-heading-anchor" href="#Solving-the-Stochastic-Optimization-Problem">Solving the Stochastic Optimization Problem</a><a id="Solving-the-Stochastic-Optimization-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Solving-the-Stochastic-Optimization-Problem" title="Permalink"></a></h2><p>After this small detour to understand how to cluster the stochastic scenarios using the representative periods approach, we can now solve the optimization problem with the same code as before, since the clustering is already done and the representative periods mapping is available in the database.</p><pre><code class="language-julia hljs">TEM.populate_with_defaults!(connection)
energy_problem = TEM.run_scenario(connection)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">EnergyProblem:
  - Model created!
    - Number of variables: 8726
    - Number of constraints for variable bounds: 8727
    - Number of structural constraints: 14250
  - Model solved!
    - Termination status: OPTIMAL
    - Objective value: 505.87025345933904
</code></pre><h3 id="Exploring-the-Results"><a class="docs-heading-anchor" href="#Exploring-the-Results">Exploring the Results</a><a id="Exploring-the-Results-1"></a><a class="docs-heading-anchor-permalink" href="#Exploring-the-Results" title="Permalink"></a></h3><p>Let&#39;s explore first the investement results.</p><pre><code class="language-julia hljs">investments = TIO.get_table(connection, &quot;var_assets_investment&quot;)
investments.total_capacity = investments.capacity .* investments.solution.* 1000
sort!(investments, :total_capacity, rev = true)
selected_columns = [:asset, :total_capacity]
investments[!, selected_columns]</code></pre><div><div style = "float: left;"><span>7√ó2 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">asset</th><th style = "text-align: left;">total_capacity</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">solar</td><td style = "text-align: right;">1148.01</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">wind</td><td style = "text-align: right;">998.642</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">ccgt</td><td style = "text-align: right;">794.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">electrolizer</td><td style = "text-align: right;">107.721</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">battery</td><td style = "text-align: right;">31.6667</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">ocgt</td><td style = "text-align: right;">0.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: left;">wind_offshore</td><td style = "text-align: right;">0.0</td></tr></tbody></table></div><div class="admonition is-success" id="Notice-2b037bfc3af32c12"><header class="admonition-header">Notice<a class="admonition-anchor" href="#Notice-2b037bfc3af32c12" title="Permalink"></a></header><div class="admonition-body"><p>The investement results are scenario independent. They are the first stage decisions, which are made before the uncertainty is realized. Therefore, they are the same across scenarios.</p></div></div><p>Now, let&#39;s have a look at the operational results, which are scenario dependent. For instance, let&#39;s look at the storage level of the seasonal storage for the different scenarios.</p><pre><code class="language-julia hljs">seasonal_storage_levels = TIO.get_table(connection, &quot;var_storage_level_over_clustered_year&quot;)
gdf = groupby(seasonal_storage_levels, [:asset])
n_subplots = length(gdf)
p = plot(; layout=grid(n_subplots, 1))
for (i, group) in enumerate(gdf)
    plot!(
        p[i],
        group.period_block_end,
        group.solution;
        group=group.scenario,
        title=string(unique(group.asset)),
        xlabel=&quot;Day&quot;,
        ylabel=&quot;[GWh]&quot;,
        xticks=0:30:365,
        dpi=600,
    )
end
p</code></pre><img src="11c6f0bd.svg" alt="Example block output"/><p>Here we can see the seasonal storage level for the different scenarios. We can see that the storage level is different across scenarios, which is expected since they are second stage decisions, which are made after the uncertainty is realized. We can also see that the storage level follows a seasonal pattern, which is captured by the representative periods.</p><p><strong>But, wait! We didn&#39;t define any probability, so what happened?</strong></p><p>The answer is that if there are no probabilities defined, TulipaEnergyModel.jl assumes that all scenarios are equally likely. Let&#39;s check the table <code>stochastic_scenario</code> to see the probabilities of the scenarios.</p><pre><code class="language-julia hljs">TIO.get_table(connection, &quot;stochastic_scenario&quot;)</code></pre><div><div style = "float: left;"><span>3√ó3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">scenario</th><th style = "text-align: left;">probability</th><th style = "text-align: left;">description</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1995</td><td style = "text-align: right;">0.333333</td><td style = "text-align: left;"></td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">2008</td><td style = "text-align: right;">0.333333</td><td style = "text-align: left;"></td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">2009</td><td style = "text-align: right;">0.333333</td><td style = "text-align: left;"></td></tr></tbody></table></div><p>Let&#39;s play around with the probabilities and see how it affects the results. For instance, let&#39;s say that we want to assign a higher probability to the scenario 2008, which has a lower average renewable availability and hydro inflows, to see how the model reacts to that.</p><h3 id="Modifying-the-probabilities-in-the-database"><a class="docs-heading-anchor" href="#Modifying-the-probabilities-in-the-database">Modifying the probabilities in the database</a><a id="Modifying-the-probabilities-in-the-database-1"></a><a class="docs-heading-anchor-permalink" href="#Modifying-the-probabilities-in-the-database" title="Permalink"></a></h3><p>If you want to define different probabilities for the scenarios, you can add the file <code>stochastic-scenario.csv</code> to your input directory (or create a table with the name <code>stochastic_scenario</code> in your database), check the <a href="../../20-user-guide/54-input-table-schemas/#table-schemas">table schemas</a> for further information. Another option is to modify the table in the database directly by using SQL or by using the <code>DBInterface.execute!</code> function in Julia.</p><pre><code class="language-julia hljs">DBInterface.execute(
    connection,
    &quot;&quot;&quot;
    UPDATE stochastic_scenario
    SET probability = CASE
        WHEN scenario = &#39;1995&#39; THEN 0.1
        WHEN scenario = &#39;2008&#39; THEN 0.8
        WHEN scenario = &#39;2009&#39; THEN 0.1
        ELSE probability
    END;
    &quot;&quot;&quot;,
)
TIO.get_table(connection, &quot;stochastic_scenario&quot;)</code></pre><div><div style = "float: left;"><span>3√ó3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">scenario</th><th style = "text-align: left;">probability</th><th style = "text-align: left;">description</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1995</td><td style = "text-align: right;">0.1</td><td style = "text-align: left;"></td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">2008</td><td style = "text-align: right;">0.8</td><td style = "text-align: left;"></td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">2009</td><td style = "text-align: right;">0.1</td><td style = "text-align: left;"></td></tr></tbody></table></div><div class="admonition is-success" id="Probabilities-should-sum-up-to-1-baca3f6293a96599"><header class="admonition-header">Probabilities should sum up to 1<a class="admonition-anchor" href="#Probabilities-should-sum-up-to-1-baca3f6293a96599" title="Permalink"></a></header><div class="admonition-body"><p>Bear in  mind that the probabilities should sum up to 1. This way, the optimization problem will take into account the different probabilities of the scenarios when making decisions.</p></div></div><p>Let&#39;s solve the optimization problem again with the new probabilities and see how it affects the results.</p><pre><code class="language-julia hljs">TEM.populate_with_defaults!(connection)
energy_problem = TEM.run_scenario(connection)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">EnergyProblem:
  - Model created!
    - Number of variables: 8726
    - Number of constraints for variable bounds: 8727
    - Number of structural constraints: 14250
  - Model solved!
    - Termination status: OPTIMAL
    - Objective value: 511.7660636889904
</code></pre><p>In this case, the investments change to invest less in wind and more in solar and ccgt, which is expected since the scenario with lower renewable availability (2008) has a higher probability. The model is trying to hedge against the possibility of having a year with low renewable availability by investing more in solar, which has a more stable availability compared to wind. The ccgt investment also increases to provide more flexibility to the system in case of low renewable availability.:</p><pre><code class="language-julia hljs">investments = TIO.get_table(connection, &quot;var_assets_investment&quot;)
investments.total_capacity = investments.capacity .* investments.solution.* 1000
sort!(investments, :total_capacity, rev = true)
selected_columns = [:asset, :total_capacity]
investments[!, selected_columns]</code></pre><div><div style = "float: left;"><span>7√ó2 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">asset</th><th style = "text-align: left;">total_capacity</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">solar</td><td style = "text-align: right;">1194.38</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">wind</td><td style = "text-align: right;">812.136</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">ccgt</td><td style = "text-align: right;">805.696</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">electrolizer</td><td style = "text-align: right;">109.341</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">battery</td><td style = "text-align: right;">31.6667</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">ocgt</td><td style = "text-align: right;">0.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: left;">wind_offshore</td><td style = "text-align: right;">0.0</td></tr></tbody></table></div><p>The seasonal pattern of the storage level is still captured for each scenario as before accounting for the second stage decisions given the new investments.</p><pre><code class="language-julia hljs">seasonal_storage_levels = TIO.get_table(connection, &quot;var_storage_level_over_clustered_year&quot;)
gdf = groupby(seasonal_storage_levels, [:asset])
n_subplots = length(gdf)
p = plot(; layout=grid(n_subplots, 1))
for (i, group) in enumerate(gdf)
    plot!(
        p[i],
        group.period_block_end,
        group.solution;
        group=group.scenario,
        title=string(unique(group.asset)),
        xlabel=&quot;Day&quot;,
        ylabel=&quot;[GWh]&quot;,
        xticks=0:30:365,
        dpi=600,
    )
end
p</code></pre><img src="802b65e5.svg" alt="Example block output"/><h3 id="Conclusion"><a class="docs-heading-anchor" href="#Conclusion">Conclusion</a><a id="Conclusion-1"></a><a class="docs-heading-anchor-permalink" href="#Conclusion" title="Permalink"></a></h3><p>In this tutorial, we have seen how to implement two-stage stochastic optimization with TulipaEnergyModel.jl and TulipaClustering.jl. We have seen how to cluster the scenarios per or cross scenario, and how to visualize the representative periods mapping with a heat map. We have also seen how to solve the optimization problem and explore the results, and how to modify the probabilities of the scenarios to see how it affects the results. This approach allows us to capture the uncertainty in the renewable availability and demand, and make informed decisions that are feasible against different possible future conditions.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../17-multi-year-investments/">¬´ Multi-Year Investment Pathways</a><a class="docs-footer-nextpage" href="../30-workflow/">Data-Handling Workflow (Example) ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Tuesday 17 February 2026 13:24">Tuesday 17 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
