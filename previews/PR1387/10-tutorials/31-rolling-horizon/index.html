<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial 8: Rolling Horizon · TulipaEnergyModel.jl</title><meta name="title" content="Tutorial 8: Rolling Horizon · TulipaEnergyModel.jl"/><meta property="og:title" content="Tutorial 8: Rolling Horizon · TulipaEnergyModel.jl"/><meta property="twitter:title" content="Tutorial 8: Rolling Horizon · TulipaEnergyModel.jl"/><meta name="description" content="Documentation for TulipaEnergyModel.jl."/><meta property="og:description" content="Documentation for TulipaEnergyModel.jl."/><meta property="twitter:description" content="Documentation for TulipaEnergyModel.jl."/><meta property="og:url" content="https://TulipaEnergy.github.io/TulipaEnergyModel.jl/10-tutorials/31-rolling-horizon/"/><meta property="twitter:url" content="https://TulipaEnergy.github.io/TulipaEnergyModel.jl/10-tutorials/31-rolling-horizon/"/><link rel="canonical" href="https://TulipaEnergy.github.io/TulipaEnergyModel.jl/10-tutorials/31-rolling-horizon/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="TulipaEnergyModel.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">TulipaEnergyModel.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Welcome</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../11-setting-up/">Setting up</a></li><li><a class="tocitem" href="../12-basics/">Tutorial 1: The Basics</a></li><li><a class="tocitem" href="../13-assets/">Tutorial 2: Assets and Flows</a></li><li><a class="tocitem" href="../14-fully-flexible-time/">Tutorial 3: Flexible Time Resolution</a></li><li><a class="tocitem" href="../15-clustering-rep-periods/">Tutorial 4: Representative Periods with Tulipa Clustering</a></li><li><a class="tocitem" href="../16-storage/">Tutorial 5: Seasonal and Non-seasonal Storage</a></li><li><a class="tocitem" href="../17-multi-year-investments/">Tutorial 6: Multi-year investments</a></li><li><a class="tocitem" href="../30-workflow/">Tutorial 7: Workflow</a></li><li class="is-active"><a class="tocitem" href>Tutorial 8: Rolling Horizon</a><ul class="internal"><li><a class="tocitem" href="#Solution-without-rolling-horizon"><span>Solution without rolling horizon</span></a></li><li><a class="tocitem" href="#Solution-with-rolling-horizon"><span>Solution with rolling horizon</span></a></li><li><a class="tocitem" href="#Rolling-horizon-tables"><span>Rolling horizon tables</span></a></li></ul></li><li><a class="tocitem" href="../99-manual-steps/">Advanced Control</a></li></ul></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../20-user-guide/00-getting-started/">Getting Started</a></li><li><a class="tocitem" href="../../20-user-guide/20-how-to-use/">How to Use</a></li><li><a class="tocitem" href="../../20-user-guide/50-schemas/">Analysis Workflow</a></li><li><a class="tocitem" href="../../20-user-guide/55-outputs/">Output Variables</a></li><li><a class="tocitem" href="../../20-user-guide/60-structures/">Internal Model Structures</a></li></ul></li><li><a class="tocitem" href="../../30-concepts/">Concepts</a></li><li><span class="tocitem">Scientific Foundation</span><ul><li><a class="tocitem" href="../../40-scientific-foundation/40-formulation/">Mathematical Formulation</a></li><li><a class="tocitem" href="../../40-scientific-foundation/45-scientific-references/">Scientific References</a></li></ul></li><li><a class="tocitem" href="../../70-reference/">API Reference</a></li><li><a class="tocitem" href="../../80-ecosystem/">Tulipa Ecosystem</a></li><li><span class="tocitem">Contributing</span><ul><li><a class="tocitem" href="../../90-contributing/90-contributing/">Contributing Guidelines</a></li><li><a class="tocitem" href="../../90-contributing/91-developer/">Developer Documentation</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Tutorial 8: Rolling Horizon</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial 8: Rolling Horizon</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TulipaEnergy/TulipaEnergyModel.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/TulipaEnergy/TulipaEnergyModel.jl/blob/main/docs/src/10-tutorials/31-rolling-horizon.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial-8:-Rolling-Horizon"><a class="docs-heading-anchor" href="#Tutorial-8:-Rolling-Horizon">Tutorial 8: Rolling Horizon</a><a id="Tutorial-8:-Rolling-Horizon-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial-8:-Rolling-Horizon" title="Permalink"></a></h1><p>In this example we will replicate the <a href="https://jump.dev/JuMP.jl/stable/tutorials/algorithms/rolling_horizon/">rolling horizon example in JuMP</a>.</p><p>For this example we will use the <a href="https://github.com/TulipaEnergy/TulipaEnergyModel.jl/blob/main/test/inputs/Rolling%20Horizon/">Rolling Horizon</a> test files. If you are following along, make sure to download all of these files beforehand.</p><pre><code class="language-julia hljs">using DuckDB: DBInterface, DuckDB
using TulipaIO: TulipaIO
using TulipaEnergyModel: TulipaEnergyModel

# Define rolling_horizon_folder as the path to where you download the data
connection = DBInterface.connect(DuckDB.DB)
schemas = TulipaEnergyModel.schema_per_table_name
TulipaIO.read_csv_folder(connection, rolling_horizon_folder; schemas)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">DuckDB.DB(&quot;:memory:&quot;)</code></pre><p>To better visualize the data, we will create a helper function <code>nice_query</code>. This is optional.</p><pre><code class="language-julia hljs">using DataFrames

nice_query(sql) = DuckDB.query(connection, sql) |&gt; DataFrame</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">nice_query (generic function with 1 method)</code></pre><p>In this data, we have four assets: <code>solar</code>, <code>thermal</code>, <code>battery</code> and <code>demand</code>. You can see the connection between them in the <code>flow</code> table:</p><pre><code class="language-julia hljs">nice_query(&quot;SELECT from_asset, to_asset FROM flow&quot;)</code></pre><div><div style = "float: left;"><span>4×2 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">from_asset</th><th style = "text-align: left;">to_asset</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">solar</td><td style = "text-align: left;">demand</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">thermal</td><td style = "text-align: left;">demand</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">battery</td><td style = "text-align: left;">demand</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">demand</td><td style = "text-align: left;">battery</td></tr></tbody></table></div><h2 id="Solution-without-rolling-horizon"><a class="docs-heading-anchor" href="#Solution-without-rolling-horizon">Solution without rolling horizon</a><a id="Solution-without-rolling-horizon-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-without-rolling-horizon" title="Permalink"></a></h2><p>Let&#39;s first solve this problem directly and inspect the solution</p><pre><code class="language-julia hljs">energy_problem = TulipaEnergyModel.run_scenario(connection, show_log=false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">EnergyProblem:
  - Model created!
    - Number of variables: 840
    - Number of constraints for variable bounds: 840
    - Number of structural constraints: 1344
  - Model solved!
    - Termination status: OPTIMAL
    - Objective value: 410873.921751175
</code></pre><p>We will aggregate the flow solution and visualize the &quot;solar&quot; and &quot;thermal&quot; assets, and the &quot;charge&quot; and &quot;discharge&quot; of the battery.</p><pre><code class="language-julia hljs">using Plots: Plots

big_table_no_rh = nice_query(&quot;&quot;&quot;
    WITH cte_outgoing AS (
        SELECT
            var.from_asset AS asset,
            var.time_block_start AS timestep,
            SUM(var.solution) AS solution,
        FROM var_flow AS var
        WHERE rep_period = 1 AND year = 2030
        GROUP BY asset, timestep
    ), cte_incoming AS (
        SELECT
            var.to_asset AS asset,
            var.time_block_start AS timestep,
            SUM(var.solution) AS solution,
        FROM var_flow AS var
        WHERE rep_period = 1 AND year = 2030
        GROUP BY asset, timestep
    ), cte_unified AS (
        SELECT
            cte_outgoing.asset,
            cte_outgoing.timestep,
            coalesce(cte_outgoing.solution, 0.0) AS outgoing,
            coalesce(cte_incoming.solution, 0.0) AS incoming,
        FROM cte_outgoing
        LEFT JOIN cte_incoming
            ON cte_outgoing.asset = cte_incoming.asset
            AND cte_outgoing.timestep = cte_incoming.timestep
    ) FROM cte_unified
&quot;&quot;&quot;)

timestep = range(extrema(big_table_no_rh.timestep)...)
thermal = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;thermal&quot;, :], :timestep).outgoing
solar = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;solar&quot;, :], :timestep).outgoing
discharge = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;battery&quot;, :], :timestep).outgoing
charge = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;battery&quot;, :], :timestep).incoming

horizon_length = length(timestep)
y = hcat(thermal, solar, discharge)
Plots.plot(;
    ylabel = &quot;MW&quot;,
    xlims = (1, horizon_length),
    xticks = 1:12:horizon_length,
    size = (800, 150),
    legend = :outerright,
)

Plots.areaplot!(timestep, y; label = [&quot;thermal&quot; &quot;solar&quot; &quot;discharge&quot;])
Plots.areaplot!(timestep, -charge; label = &quot;charge&quot;)</code></pre><img src="f57c3598.svg" alt="Example block output"/><h2 id="Solution-with-rolling-horizon"><a class="docs-heading-anchor" href="#Solution-with-rolling-horizon">Solution with rolling horizon</a><a id="Solution-with-rolling-horizon-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-with-rolling-horizon" title="Permalink"></a></h2><p>The rolling horizon solution is obtained by considering a model in a smaller timeframe, called the &quot;optimisation window&quot;. We limit out data to only the timesteps inside the optimisation window, solve the model that we obtain, save part of the solution, and move the window forward by some amount.</p><p>The &quot;move forward&quot; amount defines how much of the solution we store, and how much we move the window forward.</p><p>Some variables from previous windows are used to update relevant parameters. Most notably, the initial storage value of the batteries start at a given parameter, but after the first window, it is updated to use the solution obtained in the previous window.</p><p>This process is repeated until the complete horizon is covered by the <strong>&quot;move forward&quot; window</strong>. This is done since only the solution in the &quot;move forward&quot; window is copied to the full problem.</p><p>This also means that the optimisation window is larger than the horizon. To handle this, we &quot;loop around&quot; the horizon, i.e., we extend the profiles by defining the profile at <code>timestep = horizon + X</code> to be the profile at <code>X</code>.</p><p>The image below (recreated from the JuMP tutorial) exemplifies the process:</p><pre><code class="language-julia hljs">profiles = nice_query(&quot;FROM profiles&quot;)
demand = sort(profiles[profiles.profile_name .== &quot;demand-demand-2030&quot;,:], :timestep)
solar = sort(profiles[profiles.profile_name .== &quot;solar-availability-2030&quot;,:], :timestep)

horizon_length = size(demand, 1)
move_forward = 24
opt_window_length = 48

plots = Plots.Plot[]
for window_id = 1:2
    plt = if window_id == 1
        Plots.plot(leg = :bottomright)
    else
        Plots.plot(leg = false)
    end
    Plots.plot!(
        plt,
        demand.timestep,
        demand.value,
        c = :blue,
        lw = 2,
        label = &quot;demand&quot;,
    )
    Plots.plot!(plt,
        solar.timestep,
        solar.value,
        c = :red,
        lw = 2,
        label = &quot;solar&quot;,
    )
    window_start = (window_id - 1) * move_forward
    Plots.vspan!(
        plt,
        [window_start, window_start + opt_window_length],
        alpha = 0.25,
        c = :green,
        label = &quot;optimisation window&quot;,
    )
    push!(plots, plt)
end
Plots.plot!(plots..., layout = (length(plots), 1), size = (800, 150 * length(plots)))</code></pre><img src="c64266da.svg" alt="Example block output"/><p>To solve the same problem using rolling horizon, we use <a href="../../70-reference/#TulipaEnergyModel.run_rolling_horizon-Tuple{Any, Any, Any}"><code>run_rolling_horizon</code></a> instead of <a href="../../70-reference/#TulipaEnergyModel.run_scenario-Tuple{Any}"><code>run_scenario</code></a>. In addition to the <code>connection</code>, we also give the <code>move_forward</code> and the <code>opt_window_length</code> positional parameters.</p><pre><code class="language-julia hljs">energy_problem = TulipaEnergyModel.run_rolling_horizon(
    connection,
    move_forward,
    opt_window_length,
    show_log = false,
    save_rolling_solution = true, # optional: saves intermediate solutions
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">EnergyProblem:
  - Solved using rolling horizon. Internal model info:
    - Number of variables: 337
    - Number of constraints for variable bounds: 337
    - Number of structural constraints: 384
  - Model solved!
    - Termination status: OPTIMAL
    - Objective value: NaN
</code></pre><p>To visualise each step of the rolling horizon solution, we set <code>save_rolling_solution = true</code>, but that&#39;s optional. The default option is to ignore those extras tables to save storage.</p><pre><code class="language-julia hljs">big_table_rh_all = nice_query(&quot;&quot;&quot;
    WITH cte_outgoing AS (
        SELECT
            rolsol.window_id,
            var.from_asset AS asset,
            var.time_block_start AS timestep,
            sum(rolsol.solution) AS solution
        FROM rolling_solution_var_flow AS rolsol
        LEFT JOIN var_flow AS var
            ON rolsol.var_id = var.id
        GROUP BY window_id, asset, timestep
    ), cte_incoming AS (
        SELECT
            rolsol.window_id,
            var.to_asset AS asset,
            var.time_block_start AS timestep,
            sum(rolsol.solution) AS solution
        FROM rolling_solution_var_flow AS rolsol
        LEFT JOIN var_flow AS var
            ON rolsol.var_id = var.id
        GROUP BY window_id, asset, timestep
    ), cte_unified AS (
        SELECT
            cte_outgoing.window_id,
            cte_outgoing.asset,
            cte_outgoing.timestep,
            coalesce(cte_outgoing.solution) AS outgoing,
            coalesce(cte_incoming.solution) AS incoming,
        FROM cte_outgoing
        LEFT JOIN cte_incoming
            ON cte_outgoing.window_id = cte_incoming.window_id
            AND cte_outgoing.asset = cte_incoming.asset
            AND cte_outgoing.timestep = cte_incoming.timestep
    ), cte_full_asset_data AS (
        SELECT
            cte_unified.*,
            IF(
                cte_unified.timestep &lt; roldata.window_start,
                cte_unified.timestep + 168,
                cte_unified.timestep
            ) AS adjusted_timestep,
            asset.type,
        FROM cte_unified
        LEFT JOIN asset
            ON cte_unified.asset = asset.asset
        LEFT JOIN rolling_horizon_window AS roldata
            ON roldata.id = cte_unified.window_id
    )
    FROM cte_full_asset_data
&quot;&quot;&quot;)

num_windows = TulipaEnergyModel.get_num_rows(connection, &quot;rolling_horizon_window&quot;)
horizon_length = maximum(big_table_rh_all.timestep)

big_table_rh_grouped = groupby(big_table_rh_all, :window_id)
rolling_horizon_window_df = sort(nice_query(&quot;FROM rolling_horizon_window&quot;), :id)
plots = Plots.Plot[]

for ((window_id,), window_table) in pairs(big_table_rh_grouped)
    window_row = rolling_horizon_window_df[window_id, :]
    window_start = window_row.window_start

    timestep = range(extrema(window_table.adjusted_timestep)...)
    thermal = sort(window_table[window_table.asset .== &quot;thermal&quot;, :], :adjusted_timestep).outgoing
    solar = sort(window_table[window_table.asset .== &quot;solar&quot;, :], :adjusted_timestep).outgoing
    discharge = sort(window_table[window_table.asset .== &quot;battery&quot;, :], :adjusted_timestep).outgoing
    charge = sort(window_table[window_table.asset .== &quot;battery&quot;, :], :adjusted_timestep).incoming

    y = hcat(thermal, solar, discharge)
    plt = if window_id == 1
        Plots.plot(leg = :bottomright)
    else
        Plots.plot(leg = false)
    end
    Plots.plot!(
        plt;
        ylabel = &quot;MW&quot;,
        xlims = (1, horizon_length + opt_window_length - move_forward), # extended for the loop around
        xticks = 1:12:(horizon_length + 1),
        size = (800, 150),
    )
    Plots.areaplot!(plt, timestep, y; label = [&quot;thermal&quot; &quot;solar&quot; &quot;discharge&quot;])
    Plots.areaplot!(plt, timestep, -charge; label = &quot;charge&quot;)
    push!(plots, plt)
end
Plots.plot!(plots..., layout = (length(plots), 1), size = (800, 150 * length(plots)))</code></pre><img src="eb3421c5.svg" alt="Example block output"/><p>We can also look at the full solution. Notice that the code below is the same as the non-rolling horizon version (except for the name) because the solution populates the full model solution.</p><pre><code class="language-julia hljs">big_table_rh = nice_query(&quot;&quot;&quot;
    WITH cte_outgoing AS (
        SELECT
            var.from_asset AS asset,
            var.time_block_start AS timestep,
            SUM(var.solution) AS solution,
        FROM var_flow AS var
        WHERE rep_period = 1 AND year = 2030
        GROUP BY asset, timestep
    ), cte_incoming AS (
        SELECT
            var.to_asset AS asset,
            var.time_block_start AS timestep,
            SUM(var.solution) AS solution,
        FROM var_flow AS var
        WHERE rep_period = 1 AND year = 2030
        GROUP BY asset, timestep
    ), cte_unified AS (
        SELECT
            cte_outgoing.asset,
            cte_outgoing.timestep,
            coalesce(cte_outgoing.solution, 0.0) AS outgoing,
            coalesce(cte_incoming.solution, 0.0) AS incoming,
        FROM cte_outgoing
        LEFT JOIN cte_incoming
            ON cte_outgoing.asset = cte_incoming.asset
            AND cte_outgoing.timestep = cte_incoming.timestep
    ) FROM cte_unified
&quot;&quot;&quot;)

timestep = range(extrema(big_table_rh.timestep)...)
thermal = sort(big_table_rh[big_table_rh.asset .== &quot;thermal&quot;, :], :timestep).outgoing
solar = sort(big_table_rh[big_table_rh.asset .== &quot;solar&quot;, :], :timestep).outgoing
discharge = sort(big_table_rh[big_table_rh.asset .== &quot;battery&quot;, :], :timestep).outgoing
charge = sort(big_table_rh[big_table_rh.asset .== &quot;battery&quot;, :], :timestep).incoming

horizon_length = length(timestep)
y = hcat(thermal, solar, discharge)
Plots.plot(;
    ylabel = &quot;MW&quot;,
    xlims = (1, horizon_length),
    xticks = 1:12:horizon_length,
    size = (800, 150),
    legend = :outerright,
)

Plots.areaplot!(timestep, y; label = [&quot;thermal&quot; &quot;solar&quot; &quot;discharge&quot;])
Plots.areaplot!(timestep, -charge; label = &quot;charge&quot;)</code></pre><img src="5d353ef5.svg" alt="Example block output"/><h3 id="Comparison"><a class="docs-heading-anchor" href="#Comparison">Comparison</a><a id="Comparison-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison" title="Permalink"></a></h3><p>For completeness, let&#39;s show the difference between the solutions using rolling horizon and not using it.</p><pre><code class="language-julia hljs">thermal_no_rh = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;thermal&quot;, :], :timestep).outgoing
solar_no_rh = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;solar&quot;, :], :timestep).outgoing
discharge_no_rh = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;battery&quot;, :], :timestep).outgoing
charge_no_rh = sort(big_table_no_rh[big_table_no_rh.asset .== &quot;battery&quot;, :], :timestep).incoming
thermal_rh = sort(big_table_rh[big_table_rh.asset .== &quot;thermal&quot;, :], :timestep).outgoing
solar_rh = sort(big_table_rh[big_table_rh.asset .== &quot;solar&quot;, :], :timestep).outgoing
discharge_rh = sort(big_table_rh[big_table_rh.asset .== &quot;battery&quot;, :], :timestep).outgoing
charge_rh = sort(big_table_rh[big_table_rh.asset .== &quot;battery&quot;, :], :timestep).incoming

both_plots = [
    Plots.plot(;
        ylabel = &quot;MW&quot;,
        xlims = (1, horizon_length),
        xticks = 1:12:horizon_length,
        size = (800, 150),
        legend = :outerright,
    ) for _ in 1:2
]

y = hcat(thermal_no_rh, solar_no_rh, discharge_no_rh)
Plots.areaplot!(both_plots[1], timestep, y; label = [&quot;thermal&quot; &quot;solar&quot; &quot;discharge&quot;])
Plots.areaplot!(both_plots[1], timestep, -charge_no_rh; label = &quot;charge&quot;)

y = hcat(thermal_rh, solar_rh, discharge_rh)
Plots.areaplot!(both_plots[2], timestep, y; label = [&quot;thermal&quot; &quot;solar&quot; &quot;discharge&quot;])
Plots.areaplot!(both_plots[2], timestep, -charge_rh; label = &quot;charge&quot;)

Plots.plot(both_plots..., layout = (2, 1), size = (800, 150 * 2))</code></pre><img src="2dca796c.svg" alt="Example block output"/><p>Finally, as a sanity check, we can compare that indeed both solutions reach the same demand value by comparing the aggregated outgoing flow and the charge between the rolling horizon and the no-rolling horizon versions.</p><pre><code class="language-julia hljs">outgoing_rh = thermal_rh + solar_rh + discharge_rh
outgoing_no_rh = thermal_no_rh + solar_no_rh + discharge_no_rh

Plots.plot(
    Plots.plot(timestep, outgoing_no_rh - outgoing_rh, title=&quot;thermal + solar + discharge error&quot;),
    Plots.plot(timestep, charge_no_rh - charge_rh, title=&quot;charge error&quot;),
    layout = (2, 1),
    size = (800, 150 * 2),
    xticks = 1:move_forward:horizon_length,
)</code></pre><img src="a1847abd.svg" alt="Example block output"/><h2 id="Rolling-horizon-tables"><a class="docs-heading-anchor" href="#Rolling-horizon-tables">Rolling horizon tables</a><a id="Rolling-horizon-tables-1"></a><a class="docs-heading-anchor-permalink" href="#Rolling-horizon-tables" title="Permalink"></a></h2><p>In addition to the tables normally created by Tulipa, we also stored tables specific for rolling horizon. Still using the same input as the tutorial above, let&#39;s explore these tables.</p><h3 id="rolling_horizon_window"><a class="docs-heading-anchor" href="#rolling_horizon_window"><code>rolling_horizon_window</code></a><a id="rolling_horizon_window-1"></a><a class="docs-heading-anchor-permalink" href="#rolling_horizon_window" title="Permalink"></a></h3><p>Contain information of each window of the rolling horizon. Notably, this table stores the objective value of each window.</p><pre><code class="language-julia hljs">nice_query(&quot;FROM rolling_horizon_window&quot;)</code></pre><div><div style = "float: left;"><span>7×5 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">id</th><th style = "text-align: left;">window_start</th><th style = "text-align: left;">move_forward</th><th style = "text-align: left;">opt_window_length</th><th style = "text-align: left;">objective_value</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: right;">1</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.03424e5</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">2</td><td style = "text-align: right;">25</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.20394e5</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">3</td><td style = "text-align: right;">49</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.09303e5</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">4</td><td style = "text-align: right;">73</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.08443e5</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">5</td><td style = "text-align: right;">97</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.2291e5</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: right;">6</td><td style = "text-align: right;">121</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.37268e5</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: right;">7</td><td style = "text-align: right;">145</td><td style = "text-align: right;">24</td><td style = "text-align: right;">48</td><td style = "text-align: right;">1.18007e5</td></tr></tbody></table></div><h3 id="rolling_solution_var_%"><a class="docs-heading-anchor" href="#rolling_solution_var_%"><code>rolling_solution_var_%</code></a><a id="rolling_solution_var_%-1"></a><a class="docs-heading-anchor-permalink" href="#rolling_solution_var_%" title="Permalink"></a></h3><p>For each variable table <code>var_X</code>, a <code>rolling_solution_var_X</code> is created if <code>save_rolling_solution</code> is <code>true</code>. This table stores the intermediate solution per window, including the full optimisation window.</p><pre><code class="language-julia hljs">nice_query(&quot;FROM rolling_solution_var_flow ORDER BY RANDOM() LIMIT 5&quot;)</code></pre><div><div style = "float: left;"><span>5×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">window_id</th><th style = "text-align: left;">var_id</th><th style = "text-align: left;">solution</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Int32" style = "text-align: left;">Int32</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">6</td><td style = "text-align: right;">469</td><td style = "text-align: right;">0.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">6</td><td style = "text-align: right;">471</td><td style = "text-align: right;">10.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">6</td><td style = "text-align: right;">494</td><td style = "text-align: right;">0.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">5</td><td style = "text-align: right;">466</td><td style = "text-align: right;">0.0</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">7</td><td style = "text-align: right;">157</td><td style = "text-align: right;">97.1014</td></tr></tbody></table></div><h3 id="full_%-(intermediate)"><a class="docs-heading-anchor" href="#full_%-(intermediate)"><code>full_%</code> (intermediate)</a><a id="full_%-(intermediate)-1"></a><a class="docs-heading-anchor-permalink" href="#full_%-(intermediate)" title="Permalink"></a></h3><p>During the execution of the rolling horizon, we also created intermediate tables to store the full problem. These are named <code>full_X</code> for each varable table <code>X</code>, and for the <code>rep_periods_data</code> and <code>year_data</code> tables.</p><p>The <code>rep_periods_data</code> and <code>year_data</code> are modified to pretend that the horizon is limited to the optimisation window, thus the <code>full_X</code> version of these tables serve as backup.</p><p>The <code>full_var_X</code> tables are created to hold the final solution of rolling horizon execution. For each window, we copy all <code>var_X</code> solution within the &quot;move forward&quot; window to the correct position in <code>full_var_X</code>. After the rolling horizon execution is completed, the <code>full_var_X</code> tables are renamed to <code>var_X</code>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../30-workflow/">« Tutorial 7: Workflow</a><a class="docs-footer-nextpage" href="../99-manual-steps/">Advanced Control »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Monday 20 October 2025 15:00">Monday 20 October 2025</span>. Using Julia version 1.12.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
